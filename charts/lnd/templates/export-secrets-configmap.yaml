apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ printf "%s-export-secrets" (include "lnd.fullname" .) }}
  labels:
    {{- include "lnd.labels" . | nindent 4 }}
data:
  exportSecrets.sh: |
    #!/bin/sh

    apk update
    apk add expect curl ca-certificates openssl xxd

    kubectl wait --for=condition=ready --timeout=150s pod {{ include "lnd.fullname" . }}-0
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/tls.cert ./tls.cert
    export TLS=$(base64 ./tls.cert | tr -d '\n\r')
    kubectl create secret generic {{ include "lnd.fullname" . }}-tls --from-literal=tls.cert=$TLS --dry-run=client -o yaml | kubectl apply -f -
    kubectl create secret generic {{ include "lnd.fullname" . }}-loop-tls --from-file=./tls.cert --dry-run=client -o yaml | kubectl apply -f -
    mkdir macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/admin.macaroon ./macaroon/admin.macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/readonly.macaroon ./macaroon/readonly.macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/invoices.macaroon ./macaroon/invoices.macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/chainnotifier.macaroon ./macaroon/chainnotifier.macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/signer.macaroon ./macaroon/signer.macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/walletkit.macaroon ./macaroon/walletkit.macaroon
    kubectl cp {{ include "lnd.fullname" . }}-0:/root/.lnd/data/chain/bitcoin/$NETWORK/router.macaroon ./macaroon/router.macaroon
    export MACAROON=$(base64 ./macaroon/admin.macaroon | tr -d '\n\r')
    kubectl create secret generic {{ include "lnd.fullname" . }}-macaroon --from-literal=admin.macaroon=$MACAROON --dry-run=client -o yaml | kubectl apply -f -
    kubectl create secret generic {{ include "lnd.fullname" . }}-all-macaroons --from-file=./macaroon --dry-run=client -o yaml | kubectl apply -f -
    
    MACAROON_HEADER="Grpc-Metadata-macaroon: $(xxd -ps -u -c 1000 ./macaroon/admin.macaroon)" 
    export PUBKEY=$(curl -s --cacert ./tls.cert --header "$MACAROON_HEADER"  https://{{ include "lnd.fullname" . }}:8080/v1/getinfo | jq .identity_pubkey)
    kubectl create secret generic {{ include "lnd.fullname" . }}-pubkey --from-literal=pubkey=$PUBKEY --dry-run=client -o yaml | kubectl apply -f -
    sleep 3600