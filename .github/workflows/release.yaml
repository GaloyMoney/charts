name: Chart Release Smoketest
on:
  push: 
    branches:
      - ci-chart-release-public-test

jobs:
  release_test:
    name: Run Latest Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Start minikube
        uses: medyagh/setup-minikube@master
      - run: helm repo add galoy https://galoymoney.github.io/charts
      
      - name: Bitcoind
        run: |
          helm install bitcoind galoy/bitcoind
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=bitcoind
      
      - name: Generate 1 Block (hack)
        run: |
          kubectl exec bitcoind-0 -c bitcoind -- bitcoin-cli generatetoaddress 1 bcrt1qxcpz7ytf3nwlhjay4n04nuz8jyg3hl4ud02t9t

      - name: LND
        run: |
          helm install lnd galoy/lnd
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=lnd --timeout=60s

      - name: Galoy
        run: |
          helm install galoy galoy/galoy
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=galoy

      - name: Galoy Pay
        run: |
          helm install galoy-pay galoy/galoy-pay
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=galoy-pay

      - name: Dealer
        run: |
          helm install dealer galoy/dealer
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=dealer

      - name: Admin Panel
        run: |
          helm install admin-panel galoy/admin-panel
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=admin-panel

      # - run: helm install monitoring galoy/monitoring
      # - run: helm install rtl galoy/rtl
      # - run: helm install specter galoy/specter
      # - run: helm install web-wallet galoy/web-wallet
