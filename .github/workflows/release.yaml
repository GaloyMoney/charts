name: Chart Release Smoketest
on:
  push: 
    branches:
      - ci-chart-release-public-test

jobs:
  release_test:
    name: Run Latest Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Start minikube
        uses: medyagh/setup-minikube@master
      - run: helm repo add galoy https://galoymoney.github.io/charts
      
      - name: Bitcoind
        run: |
          helm install bitcoind ./charts/bitcoind --set global.network=regtest --set persistence.enabled=false
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=bitcoind
      
      - name: Generate 1 Block (hack)
        run: |
          kubectl exec bitcoind-0 -c bitcoind -- bitcoin-cli generatetoaddress 1 bcrt1qxcpz7ytf3nwlhjay4n04nuz8jyg3hl4ud02t9t

      - name: LND
        run: |
          pushd charts/lnd
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm dependency build
          helm install lnd .  -f ../../dev/bitcoin/lnd-values.yml

          for i in 1 2 3 4 5 6 7 8 9 10
          do
            echo $i
            kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=lnd --timeout=30s
            kubectl get pods
          done

          popd

      - name: Galoy
        run: |
          helm install galoy galoy/galoy
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=galoy

      - name: Galoy Pay
        run: |
          helm install galoy-pay galoy/galoy-pay
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=galoy-pay

      - name: Dealer
        run: |
          helm install dealer galoy/dealer
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=dealer

      - name: Admin Panel
        run: |
          helm install admin-panel galoy/admin-panel
          kubectl wait pods -n default --for=condition=Ready -l app.kubernetes.io/name=admin-panel

      # - run: helm install monitoring galoy/monitoring
      # - run: helm install rtl galoy/rtl
      # - run: helm install specter galoy/specter
      # - run: helm install web-wallet galoy/web-wallet
