name: dev-smoketest
concurrency: dev-smoketest
on:
  push:
    branches:
      - ci-testflight-github-action
jobs:
  smoketest:
    name: Hit smoketests against Charts in Dev Setup
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - uses: AbsaOSS/k3d-action@v2
        name: "Create Single Cluster"
        with:
          cluster-name: "k3s-default"
          args: >-
            -v "$(pwd):/charts"
            --k3s-arg --disable=traefik@server:0
            --k3s-arg --disable=servicelb@server:0
      - name: Run the Charts in Dev Mode
        run: |
          pushd dev && source ./.envrc
          make init
          make deploy-services
          make deploy
      # - name: Bitcoin Smoketest
      #   run: |
      #     pushd dev && source ./.envrc
      #     kubectl -n galoy-dev-smoketest exec smoketest -- bash -c "cd /charts/ci/tasks && \
      #       CHART=bitcoind ./dev-smoketest-settings.sh && \
      #       ./bitcoind-smoketest.sh regtest && \
      #       rm -rf smoketest-settings"
      - name: Galoy Smoketest
        run: |
          pushd dev && source ./.envrc
          kubectl -n galoy-dev-smoketest exec smoketest -- bash -c "cd /charts/ci/tasks && \
            CHART=galoy ./dev-smoketest-settings.sh && \
            ./galoy-smoketest.sh && \
            rm -rf smoketest-settings"
      - name: Delete K3D Cluster
        if: always()
        run: |
          k3d cluster delete --all
