apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: kafka-source-mongo
  namespace: galoy-dev-kafka
  labels:
    strimzi.io/cluster: kafka
spec:
  class: com.mongodb.kafka.connect.MongoSourceConnector
  tasksMax: 1
  config:
    connection.uri: mongodb://testGaloy:password@galoy-mongodb-headless.galoy-dev-galoy.svc.cluster.local:27017/?authSource=galoy&replicaSet=rs0

    database: galoy
    collection: accounts,changelog,dbmetadatas,invoiceusers,lnpayments,medici_balances,medici_journals,medici_locks,medici_transaction_metadatas,medici_transactions,payment_flow_states
    topic.prefix: mongodb-
    transforms.underscoreToHyphen.type: org.apache.kafka.connect.transforms.RegexRouter
    transforms.underscoreToHyphen.regex: "mongodb-(.*)_(.*)"
    transforms.underscoreToHyphen.replacement: "mongodb-$1-$2"

    # updates only
    #pipeline: '[{"$match": {"operationType": "insert"}}, {"$addFields" : {"fullDocument.travel":"MongoDB Kafka Connector"}}]'
    # backfill only
    pipeline: '[{"$match": {"operationType": "insert", "fullDocument": "updateLookup"}}, {"$addFields" : {"fullDocument.travel":"MongoDB Kafka Connector"}}]'
    key.converter: org.apache.kafka.connect.storage.StringConverter
    value.converter: org.apache.kafka.connect.json.JsonConverter
    value.converter.schemas.enable: false
    transforms: underscoreToHyphen
